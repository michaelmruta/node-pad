module.exports = function(RED) {
    "use strict";
    
    var bodyParser = require("body-parser");
    var jsonParser = bodyParser.json();
    var once = false

    function System(n) {

        RED.nodes.createNode(this,n);
        this.topic = n.topic;
        var node = this;

        if(!once) {
            RED.httpNode.post("/system", jsonParser, function(req,res) {
                if(req.headers.host == "127.0.0.1:1880") {        
                    node.send({_msgid:RED.util.generateId(), payload:req.body})
                }
                res.end()
            });
            once = true
        }

        this.on("close",function() {
            RED.httpNode._router.stack.forEach(function(route,i,routes) {
                if (route.route && route.route.path === '/system' && route.route.methods['post']) {
                    routes.splice(i,1);
                }
                once = false;
            });
        });

    }

    RED.nodes.registerType("system",System);
}
